"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/core");
const lambda = require("@aws-cdk/aws-lambda");
const dynamodb = require("@aws-cdk/aws-dynamodb");
const apigw = require("@aws-cdk/aws-apigateway");
const iam = require("@aws-cdk/aws-iam");
const aws_iam_1 = require("@aws-cdk/aws-iam");
class LeastPrivilegeWebserviceStack extends cdk.Stack {
    constructor(scope, id, props) {
        var _a, _b, _c, _d, _e;
        super(scope, id, props);
        // ========================================================================================================
        // Resource: AWS DynamoDB Table
        // ========================================================================================================
        this.blogTable = new dynamodb.Table(this, 'Blogs', {
            partitionKey: { name: 'title', type: dynamodb.AttributeType.STRING },
            tableName: 'blogs',
            // The default removal policy is RETAIN, which means that cdk destroy will not attempt to delete
            // the new table, and it will remain in your account until manually deleted. By setting the policy to 
            // DESTROY, cdk destroy will delete the table (even if it has data in it)
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // ========================================================================================================
        //  Resource: AWS Lambda
        // ========================================================================================================
        const createBlogLda = new lambda.Function(this, 'createBlogsHandler', {
            runtime: lambda.Runtime.NODEJS_12_X,
            code: lambda.Code.fromAsset('lambda-fns'),
            handler: 'createBlog.handler',
            environment: {
                BLOGS_TABLE_NAME: this.blogTable.tableName,
                PRIMARY_KEY: 'itemId'
            }
        });
        this.blogTable.grantReadWriteData(createBlogLda); // Give this lambda read/write privileges
        // Get HITs Function
        const getBlogslda = new lambda.Function(this, 'getBlogsHandler', {
            runtime: lambda.Runtime.NODEJS_12_X,
            code: lambda.Code.fromAsset('lambda-fns'),
            handler: 'readBlogs.handler',
            environment: {
                BLOGS_TABLE_NAME: this.blogTable.tableName,
                PRIMARY_KEY: 'itemId'
            }
        });
        this.blogTable.grantReadData(getBlogslda); // Give this lambda readonly privileges
        // ========================================================================================================
        //  Resource: AWS API Gateway - RestAPI
        // ========================================================================================================
        const restGateway = new apigw.RestApi(this, 'blogsapi');
        const blogsResource = restGateway.root.addResource('blogs');
        // We need to enable cors on this resource to enable us completing the exercise with our client application
        // ** You should remove or re-configure this securely for your end production app.
        blogsResource.addCorsPreflight({
            allowOrigins: ['*'],
            allowMethods: ['OPTIONS', 'GET', 'PUT']
        });
        // Lets create a GET method for the readOnly operation
        this.getBlogsMethod = blogsResource.addMethod('GET', new apigw.LambdaIntegration(getBlogslda), {
            authorizationType: apigw.AuthorizationType.IAM
        });
        // Lets create a PUT method for the update/create operation
        this.putBlogsMethod = blogsResource.addMethod('PUT', new apigw.LambdaIntegration(createBlogLda), {
            authorizationType: apigw.AuthorizationType.IAM
        });
        // ========================================================================================================
        //    Resource: AWS::IAM::Role 
        //        THE USER (READ-ONLY) IAM ROLE
        // ========================================================================================================
        this.userRole = new iam.Role(this, id + 'ReadOnlyRole', {
            assumedBy: new iam.FederatedPrincipal('cognito-identity.amazonaws.com', {
                "StringEquals": { "cognito-identity.amazonaws.com:aud": (_a = props) === null || _a === void 0 ? void 0 : _a.identityPoolRef },
                "ForAnyValue:StringLike": { "cognito-identity.amazonaws.com:amr": "authenticated" },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        (_b = this.userRole.assumeRolePolicy) === null || _b === void 0 ? void 0 : _b.addStatements(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            principals: [new iam.ServicePrincipal('lambda.amazonaws.com')],
            actions: ['sts:AssumeRole'],
        }));
        this.userRole.addToPolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            resources: [this.blogTable.tableArn],
            actions: [
                'dynamodb:Scan',
                'dynamodb:Query',
                'dynamodb:Get',
                'logs:CreateLogStream',
                'logs:PutLogEvents',
                "mobileanalytics:PutEvents",
                "cognito-sync:*",
                "cognito-identity:*"
            ]
        }));
        this.userRole.addToPolicy(new aws_iam_1.PolicyStatement({
            actions: ['execute-api:Invoke'],
            effect: aws_iam_1.Effect.ALLOW,
            resources: [this.getBlogsMethod.methodArn]
        }));
        this.userRole.addToPolicy(new aws_iam_1.PolicyStatement({
            actions: ["mobileanalytics:PutEvents",
                "cognito-sync:*",
                "cognito-identity:*",],
            effect: aws_iam_1.Effect.ALLOW,
            resources: ['*']
        }));
        // ========================================================================================================
        //    Resource: AWS::IAM::Role 
        //        THE USER(ADMIN) IAM ROLE
        // ========================================================================================================
        this.adminRole = new iam.Role(this, id + 'creatorRole', {
            assumedBy: new iam.FederatedPrincipal('cognito-identity.amazonaws.com', {
                "StringEquals": { "cognito-identity.amazonaws.com:aud": (_c = props) === null || _c === void 0 ? void 0 : _c.identityPoolRef },
                "ForAnyValue:StringLike": { "cognito-identity.amazonaws.com:amr": "authenticated" },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        (_d = this.adminRole.assumeRolePolicy) === null || _d === void 0 ? void 0 : _d.addStatements(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            principals: [new iam.ServicePrincipal('lambda.amazonaws.com')],
            actions: ['sts:AssumeRole'],
        }));
        this.adminRole.addToPolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            resources: [this.blogTable.tableArn],
            actions: [
                'dynamodb:Scan',
                'dynamodb:Query',
                'dynamodb:Get',
                'dynamodb:UpdateItem',
                'logs:CreateLogStream',
                'logs:PutLogEvents'
            ]
        }));
        this.adminRole.addToPolicy(new aws_iam_1.PolicyStatement({
            actions: ['execute-api:Invoke'],
            effect: aws_iam_1.Effect.ALLOW,
            resources: [this.putBlogsMethod.methodArn,
                this.getBlogsMethod.methodArn]
        }));
        this.adminRole.addToPolicy(new aws_iam_1.PolicyStatement({
            actions: ["mobileanalytics:PutEvents",
                "cognito-sync:*",
                "cognito-identity:*",],
            effect: aws_iam_1.Effect.ALLOW,
            resources: ['*']
        }));
        // Outputs
        new cdk.CfnOutput(this, 'HTTP API Url', {
            value: (_e = restGateway.url, (_e !== null && _e !== void 0 ? _e : 'Something went wrong with the deploy'))
        });
    }
}
exports.LeastPrivilegeWebserviceStack = LeastPrivilegeWebserviceStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVhc3QtcHJpdmlsZWdlLXdlYnNlcnZpY2Utc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsZWFzdC1wcml2aWxlZ2Utd2Vic2VydmljZS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFxQztBQUNyQyw4Q0FBK0M7QUFDL0Msa0RBQW1EO0FBQ25ELGlEQUFrRDtBQUNsRCx3Q0FBeUM7QUFDekMsOENBSTRCO0FBTTVCLE1BQWEsNkJBQThCLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFXeEQsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUE0Qjs7UUFDdEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsMkdBQTJHO1FBQzNHLCtCQUErQjtRQUMvQiwyR0FBMkc7UUFDM0csSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRTtZQUMvQyxZQUFZLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtZQUNwRSxTQUFTLEVBQUUsT0FBTztZQUNsQixnR0FBZ0c7WUFDaEcsc0dBQXNHO1lBQ3RHLHlFQUF5RTtZQUN6RSxhQUFhLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPO1NBQzNDLENBQUMsQ0FBQztRQUVILDJHQUEyRztRQUMzRyx3QkFBd0I7UUFDeEIsMkdBQTJHO1FBQzNHLE1BQU0sYUFBYSxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsb0JBQW9CLEVBQUU7WUFDbEUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDO1lBQ3pDLE9BQU8sRUFBRSxvQkFBb0I7WUFDN0IsV0FBVyxF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QUNwQixTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7U0FDbkIsQ0FBQyxDQUNMLENBQUE7UUFFRCxVQUFVO1FBQ1YsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7WUFDcEMsS0FBSyxRQUFFLFdBQVcsQ0FBQyxHQUFHLHVDQUFJLHNDQUFzQyxFQUFBO1NBQ25FLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQXZMRCxzRUF1TEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgbGFtYmRhID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWxhbWJkYScpO1xuaW1wb3J0IGR5bmFtb2RiID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWR5bmFtb2RiJyk7XG5pbXBvcnQgYXBpZ3cgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheScpO1xuaW1wb3J0IGlhbSA9IHJlcXVpcmUoXCJAYXdzLWNkay9hd3MtaWFtXCIpO1xuaW1wb3J0IHtcbiAgICBSb2xlLFxuICAgIFBvbGljeVN0YXRlbWVudCxcbiAgICBFZmZlY3RcbiAgfSBmcm9tICdAYXdzLWNkay9hd3MtaWFtJztcblxuaW50ZXJmYWNlIHdlYlNlcnZpY2VTdGFja1Byb3BzIGV4dGVuZHMgY2RrLlN0YWNrUHJvcHMge1xuICAgIGlkZW50aXR5UG9vbFJlZjogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgTGVhc3RQcml2aWxlZ2VXZWJzZXJ2aWNlU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuXG4gICAgLy8gdGFibGUgcmVmXG4gICAgcHVibGljIHJlYWRvbmx5IGJsb2dUYWJsZTogZHluYW1vZGIuVGFibGU7XG4gICAgLy8gYXBpJ3NcbiAgICBwdWJsaWMgcmVhZG9ubHkgZ2V0QmxvZ3NNZXRob2Q6IGFwaWd3Lk1ldGhvZDtcbiAgICBwdWJsaWMgcmVhZG9ubHkgcHV0QmxvZ3NNZXRob2Q6IGFwaWd3Lk1ldGhvZDtcbiAgICAvLyByb2xlc1xuICAgIHB1YmxpYyByZWFkb25seSB1c2VyUm9sZTogaWFtLlJvbGU7XG4gICAgcHVibGljIHJlYWRvbmx5IGFkbWluUm9sZTogaWFtLlJvbGU7XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiB3ZWJTZXJ2aWNlU3RhY2tQcm9wcykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgICAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAvLyBSZXNvdXJjZTogQVdTIER5bmFtb0RCIFRhYmxlXG4gICAgICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgIHRoaXMuYmxvZ1RhYmxlID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsICdCbG9ncycsIHtcbiAgICAgICAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAndGl0bGUnLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgICAgICAgdGFibGVOYW1lOiAnYmxvZ3MnLFxuICAgICAgICAgICAgLy8gVGhlIGRlZmF1bHQgcmVtb3ZhbCBwb2xpY3kgaXMgUkVUQUlOLCB3aGljaCBtZWFucyB0aGF0IGNkayBkZXN0cm95IHdpbGwgbm90IGF0dGVtcHQgdG8gZGVsZXRlXG4gICAgICAgICAgICAvLyB0aGUgbmV3IHRhYmxlLCBhbmQgaXQgd2lsbCByZW1haW4gaW4geW91ciBhY2NvdW50IHVudGlsIG1hbnVhbGx5IGRlbGV0ZWQuIEJ5IHNldHRpbmcgdGhlIHBvbGljeSB0byBcbiAgICAgICAgICAgIC8vIERFU1RST1ksIGNkayBkZXN0cm95IHdpbGwgZGVsZXRlIHRoZSB0YWJsZSAoZXZlbiBpZiBpdCBoYXMgZGF0YSBpbiBpdClcbiAgICAgICAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksIC8vIE5PVCByZWNvbW1lbmRlZCBmb3IgcHJvZHVjdGlvbiBjb2RlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgIC8vICBSZXNvdXJjZTogQVdTIExhbWJkYVxuICAgICAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICBjb25zdCBjcmVhdGVCbG9nTGRhID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnY3JlYXRlQmxvZ3NIYW5kbGVyJywge1xuICAgICAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEyX1gsICAgICAgLy8gZXhlY3V0aW9uIGVudmlyb25tZW50XG4gICAgICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoJ2xhbWJkYS1mbnMnKSwgIC8vIGNvZGUgbG9hZGVkIGZyb20gdGhlIFwibGFtYmRhXCIgZGlyZWN0b3J5XG4gICAgICAgICAgICBoYW5kbGVyOiAnY3JlYXRlQmxvZy5oYW5kbGVyJywgICAgICAgICAgICAgICAgLy8gZmlsZSBpcyBcImxhbWJkYVwiLCBmdW5jdGlvbiBpcyBcImhhbmRsZXJcIlxuICAgICAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAgICAgICBCTE9HU19UQUJMRV9OQU1FOiB0aGlzLmJsb2dUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgUFJJTUFSWV9LRVk6ICdpdGVtSWQnXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuYmxvZ1RhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShjcmVhdGVCbG9nTGRhKTsgLy8gR2l2ZSB0aGlzIGxhbWJkYSByZWFkL3dyaXRlIHByaXZpbGVnZXNcblxuICAgICAgICAvLyBHZXQgSElUcyBGdW5jdGlvblxuICAgICAgICBjb25zdCBnZXRCbG9nc2xkYSA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ2dldEJsb2dzSGFuZGxlcicsIHtcbiAgICAgICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLCAgICAgIC8vIGV4ZWN1dGlvbiBlbnZpcm9ubWVudFxuICAgICAgICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KCdsYW1iZGEtZm5zJyksICAvLyBjb2RlIGxvYWRlZCBmcm9tIHRoZSBcImxhbWJkYVwiIGRpcmVjdG9yeVxuICAgICAgICAgICAgaGFuZGxlcjogJ3JlYWRCbG9ncy5oYW5kbGVyJywgICAgICAgICAgICAgICAgLy8gZmlsZSBpcyBcImxhbWJkYVwiLCBmdW5jdGlvbiBpcyBcImhhbmRsZXJcIlxuICAgICAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAgICAgICBCTE9HU19UQUJMRV9OQU1FOiB0aGlzLmJsb2dUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgUFJJTUFSWV9LRVk6ICdpdGVtSWQnXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuYmxvZ1RhYmxlLmdyYW50UmVhZERhdGEoZ2V0QmxvZ3NsZGEpOyAvLyBHaXZlIHRoaXMgbGFtYmRhIHJlYWRvbmx5IHByaXZpbGVnZXNcblxuICAgICAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAvLyAgUmVzb3VyY2U6IEFXUyBBUEkgR2F0ZXdheSAtIFJlc3RBUElcbiAgICAgICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAgICAgICBjb25zdCByZXN0R2F0ZXdheSA9IG5ldyBhcGlndy5SZXN0QXBpKHRoaXMsICdibG9nc2FwaScpO1xuXG4gICAgICAgIGNvbnN0IGJsb2dzUmVzb3VyY2UgPSByZXN0R2F0ZXdheS5yb290LmFkZFJlc291cmNlKCdibG9ncycpO1xuICAgICAgICAvLyBXZSBuZWVkIHRvIGVuYWJsZSBjb3JzIG9uIHRoaXMgcmVzb3VyY2UgdG8gZW5hYmxlIHVzIGNvbXBsZXRpbmcgdGhlIGV4ZXJjaXNlIHdpdGggb3VyIGNsaWVudCBhcHBsaWNhdGlvblxuICAgICAgICAvLyAqKiBZb3Ugc2hvdWxkIHJlbW92ZSBvciByZS1jb25maWd1cmUgdGhpcyBzZWN1cmVseSBmb3IgeW91ciBlbmQgcHJvZHVjdGlvbiBhcHAuXG4gICAgICAgIGJsb2dzUmVzb3VyY2UuYWRkQ29yc1ByZWZsaWdodCh7XG4gICAgICAgICAgICBhbGxvd09yaWdpbnM6IFsnKiddLFxuICAgICAgICAgICAgYWxsb3dNZXRob2RzOiBbJ09QVElPTlMnLCAnR0VUJywgJ1BVVCddXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIExldHMgY3JlYXRlIGEgR0VUIG1ldGhvZCBmb3IgdGhlIHJlYWRPbmx5IG9wZXJhdGlvblxuICAgICAgICB0aGlzLmdldEJsb2dzTWV0aG9kID0gYmxvZ3NSZXNvdXJjZS5hZGRNZXRob2QoJ0dFVCcsIG5ldyBhcGlndy5MYW1iZGFJbnRlZ3JhdGlvbihnZXRCbG9nc2xkYSksIHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBhcGlndy5BdXRob3JpemF0aW9uVHlwZS5JQU1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTGV0cyBjcmVhdGUgYSBQVVQgbWV0aG9kIGZvciB0aGUgdXBkYXRlL2NyZWF0ZSBvcGVyYXRpb25cbiAgICAgICAgdGhpcy5wdXRCbG9nc01ldGhvZCA9IGJsb2dzUmVzb3VyY2UuYWRkTWV0aG9kKCdQVVQnLCBuZXcgYXBpZ3cuTGFtYmRhSW50ZWdyYXRpb24oY3JlYXRlQmxvZ0xkYSksIHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBhcGlndy5BdXRob3JpemF0aW9uVHlwZS5JQU1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgLy8gICAgUmVzb3VyY2U6IEFXUzo6SUFNOjpSb2xlIFxuICAgICAgICAvLyAgICAgICAgVEhFIFVTRVIgKFJFQUQtT05MWSkgSUFNIFJPTEVcbiAgICAgICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgdGhpcy51c2VyUm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBpZCArICdSZWFkT25seVJvbGUnLCB7XG4gICAgICAgICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uRmVkZXJhdGVkUHJpbmNpcGFsKCdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20nLCB7XG4gICAgICAgICAgICAgICAgXCJTdHJpbmdFcXVhbHNcIjogeyBcImNvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphdWRcIjogcHJvcHM/LmlkZW50aXR5UG9vbFJlZiB9LFxuICAgICAgICAgICAgICAgIFwiRm9yQW55VmFsdWU6U3RyaW5nTGlrZVwiOiB7IFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtclwiOiBcImF1dGhlbnRpY2F0ZWRcIiB9LFxuICAgICAgICAgICAgfSwgXCJzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eVwiKSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudXNlclJvbGUuYXNzdW1lUm9sZVBvbGljeT8uYWRkU3RhdGVtZW50cyhcbiAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgcHJpbmNpcGFsczogW25ldyBpYW0uU2VydmljZVByaW5jaXBhbCgnbGFtYmRhLmFtYXpvbmF3cy5jb20nKV0sXG4gICAgICAgICAgICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMudXNlclJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFt0aGlzLmJsb2dUYWJsZS50YWJsZUFybl0sXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICAnZHluYW1vZGI6U2NhbicsXG4gICAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpRdWVyeScsXG4gICAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpHZXQnLFxuICAgICAgICAgICAgICAgICAgICAnbG9nczpDcmVhdGVMb2dTdHJlYW0nLFxuICAgICAgICAgICAgICAgICAgICAnbG9nczpQdXRMb2dFdmVudHMnLFxuICAgICAgICAgICAgICAgICAgICBcIm1vYmlsZWFuYWx5dGljczpQdXRFdmVudHNcIixcbiAgICAgICAgICAgICAgICAgICAgXCJjb2duaXRvLXN5bmM6KlwiLFxuICAgICAgICAgICAgICAgICAgICBcImNvZ25pdG8taWRlbnRpdHk6KlwiXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy51c2VyUm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgICAgIG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnZXhlY3V0ZS1hcGk6SW52b2tlJ10sXG4gICAgICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbdGhpcy5nZXRCbG9nc01ldGhvZC5tZXRob2RBcm5dXG4gICAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICAgIHRoaXMudXNlclJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXCJtb2JpbGVhbmFseXRpY3M6UHV0RXZlbnRzXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiY29nbml0by1zeW5jOipcIixcbiAgICAgICAgICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5OipcIixdLFxuICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogWycqJ11cbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcblxuICAgICAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAvLyAgICBSZXNvdXJjZTogQVdTOjpJQU06OlJvbGUgXG4gICAgICAgIC8vICAgICAgICBUSEUgVVNFUihBRE1JTikgSUFNIFJPTEVcbiAgICAgICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAgICAgICB0aGlzLmFkbWluUm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBpZCArICdjcmVhdG9yUm9sZScsIHtcbiAgICAgICAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5GZWRlcmF0ZWRQcmluY2lwYWwoJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsIHtcbiAgICAgICAgICAgICAgICBcIlN0cmluZ0VxdWFsc1wiOiB7IFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZFwiOiBwcm9wcz8uaWRlbnRpdHlQb29sUmVmIH0sXG4gICAgICAgICAgICAgICAgXCJGb3JBbnlWYWx1ZTpTdHJpbmdMaWtlXCI6IHsgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yXCI6IFwiYXV0aGVudGljYXRlZFwiIH0sXG4gICAgICAgICAgICB9LCBcInN0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5XCIpLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hZG1pblJvbGUuYXNzdW1lUm9sZVBvbGljeT8uYWRkU3RhdGVtZW50cyhcbiAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgcHJpbmNpcGFsczogW25ldyBpYW0uU2VydmljZVByaW5jaXBhbCgnbGFtYmRhLmFtYXpvbmF3cy5jb20nKV0sXG4gICAgICAgICAgICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuYWRtaW5Sb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICAgICAgbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbdGhpcy5ibG9nVGFibGUudGFibGVBcm5dLFxuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgJ2R5bmFtb2RiOlNjYW4nLFxuICAgICAgICAgICAgICAgICAgICAnZHluYW1vZGI6UXVlcnknLFxuICAgICAgICAgICAgICAgICAgICAnZHluYW1vZGI6R2V0JyxcbiAgICAgICAgICAgICAgICAgICAgJ2R5bmFtb2RiOlVwZGF0ZUl0ZW0nLFxuICAgICAgICAgICAgICAgICAgICAnbG9nczpDcmVhdGVMb2dTdHJlYW0nLFxuICAgICAgICAgICAgICAgICAgICAnbG9nczpQdXRMb2dFdmVudHMnXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5hZG1pblJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbJ2V4ZWN1dGUtYXBpOkludm9rZSddLFxuICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogW3RoaXMucHV0QmxvZ3NNZXRob2QubWV0aG9kQXJuLFxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0QmxvZ3NNZXRob2QubWV0aG9kQXJuXVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5hZG1pblJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXCJtb2JpbGVhbmFseXRpY3M6UHV0RXZlbnRzXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiY29nbml0by1zeW5jOipcIixcbiAgICAgICAgICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5OipcIixdLFxuICAgICAgICAgICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogWycqJ11cbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcblxuICAgICAgICAvLyBPdXRwdXRzXG4gICAgICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdIVFRQIEFQSSBVcmwnLCB7XG4gICAgICAgICAgICB2YWx1ZTogcmVzdEdhdGV3YXkudXJsID8/ICdTb21ldGhpbmcgd2VudCB3cm9uZyB3aXRoIHRoZSBkZXBsb3knXG4gICAgICAgIH0pO1xuICAgIH1cbn0iXX0=